<!DOCTYPE html>
<html>
<head>
    <title>Debug Block Lines</title>
</head>
<body>
    <div id="output"></div>
    <script src="lib/miniscript-shim.js"></script>
    <script>
        const output = document.getElementById('output');
        
        function log(message) {
            console.log(message);
            output.innerHTML += message.replace(/\n/g, '<br>') + '<br>';
        }
        
        log("Testing block lines...");
        
        const interpreter = new miniscript.Interpreter();
        
        // Override the if-then block processing
        const originalRun = interpreter.run;
        interpreter.run = function(code) {
            log("=== RUN START ===");
            log("Code: " + JSON.stringify(code));
            
            const lines = code.split('\n');
            let i = 0;
            while (i < lines.length) {
                let line = lines[i].trim();
                
                if (line.startsWith("if ")) {
                    log("Found if statement: " + line);
                    let blocks = [];
                    let currentBlock = [];
                    let currentCondition = line.substring(3).trim();
                    log("Condition: " + currentCondition);
                    
                    i++;
                    while (i < lines.length && !lines[i].trim().startsWith("end if")) {
                        log("Adding line to block: " + JSON.stringify(lines[i]));
                        currentBlock.push(lines[i]);
                        i++;
                    }
                    
                    blocks.push({ condition: currentCondition, lines: currentBlock });
                    log("Block created with " + currentBlock.length + " lines");
                    log("Block lines: " + JSON.stringify(currentBlock));
                    
                    for (const block of blocks) {
                        log("Evaluating condition: " + block.condition);
                        if (interpreter.evalCondition(block.condition)) {
                            log("Condition is true, executing block");
                            const joinedCode = block.lines.join('\n');
                            log("Joined code: " + JSON.stringify(joinedCode));
                            interpreter.run(joinedCode);
                            break;
                        }
                    }
                    i++;
                    continue;
                }
                
                // Call original for other processing
                return originalRun.call(this, code);
            }
            
            log("=== RUN END ===");
        };
        
        try {
            interpreter.run(`
poppedValue = [5, 6]
if poppedValue != null then
    print "First element: " + poppedValue[0]
end if
            `);
            
        } catch (error) {
            log("Error: " + error.message);
            console.error(error);
        }
    </script>
</body>
</html>
